# Node.js/TypeScript: Standard Operating Procedures

## 0. General Standards
- **Language**: TypeScript is mandatory.
- **Linting**: `ESLint` and `Prettier` must be enforced.
- **Async/Await**: Always use `async/await` over callbacks or raw promises.

### Testing Guidelines
- **Unit Tests**: Focus on pure functions and business logic. Mock all external dependencies.
- **Integration Tests**: Test API endpoints (status codes, DB persistence).
- **Mandate**: Create the test file before the logic file.

## 1. API Design Rules (Fastify + TypeBox/Zod)
**Goal**: High-performance, schema-driven, and type-safe APIs.
- **Rule 1: Schema-First Validation**
  - Do not manually validate request bodies. Use **TypeBox** or **Zod** within Fastify's `schema` property.
  - *Requirement*: Every route must have a `body`, `querystring`, and `response` schema defined.

- **Rule 2: Error Propagation with "Custom Errors"**
  - Never throw generic `Error` strings. Use a specialized error library (e.g., `@fastify/error`) or custom classes that include a `statusCode` and an machine-readable `errorCode`.

- **Rule 3: Dependency Injection via Decorators**
  - Use Fastify's `.decorate()` or `.register()` to inject shared resources (DB clients, Logger). This avoids global variables and simplifies unit testing.

- **Rule 4: Standardize Response Models**
  - Separate your database entities from your API schemas. Even if they look identical today, they will diverge. Use a "Mapper" function to transform DB results to API responses.

## 2. Event-Driven Messaging (BullMQ / RabbitMQ / Kafka)
**Goal**: Reliable background processing and non-blocking service communication.

- **Rule 1: Reliable Queueing with BullMQ**
  - For job processing, use **BullMQ (Redis-backed)**. It handles retries, delays, and parent-child job dependencies natively in the Node.js ecosystem.

- **Rule 2: The "At Least Once" Delivery Rule**
  - Assume workers will fail mid-task. Use **Manual Acknowledgments** (`job.moveToCompleted()` or similar). Never use auto-acknowledgment for critical tasks.

- **Rule 3: Idempotent Workers (The "Key" Rule)**
  - Every worker must be idempotent.
  - *Implementation*: Use a unique `jobId` or an application-level `idempotencyKey` and check its status in Redis/Database before processing.

- **Rule 4: Graceful Shutdown**
  - Listen for `SIGTERM`/`SIGINT` signals. Use a "shutdown" handler to stop accepting new messages and finish current jobs before the process exits.

## 3. Database & ORM Rules (Prisma / Drizzle)
**Goal**: Type safety, predictable migrations, and query efficiency.
- **Rule 1: Type-Safe Queries (No `any`)**
  - Use **Prisma** or **Drizzle ORM**. Ensure the generated types are used throughout the Service layer. Never cast DB results as `any`.

- **Rule 2: Explicit Relationship Loading**
  - Prohibited: "N+1" queries by fetching relations inside a loop.
  - **Mandatory**: Use `include` (Prisma) or `with` (Drizzle) to fetch necessary relations in a single query.

- **Rule 3: Database Migrations are Mandatory**
  - Never use `sync()` or `push` in production. Every schema change must be a versioned migration file generated by your ORM and committed to version control.

- **Rule 4: Distributed ID Strategy (Hierarchy)**
  - **Primary Choice: TSID (64-bit Long)** — Use `tsidpy` or similar for sequential, distributed-safe IDs that save space.
  - **Secondary Choice: UUID v7 (128-bit)** — Use `uuid.uuid7()` (native in modern Node/TS) for standard UUID compatibility with time-sorting.
  - **Prohibited**: Serial/Auto-increment integers for public-facing resources (prevents ID scraping and scaling issues).

## 4. Observability & Logging Rules
**Goal**: Enable Ops team to detect bugs and errors effectively while protecting user data.
- **Rule 1: Full Traceability**
  - Ensure every request has a unique `request_id` or `trace_id`. Propagate this ID through all internal service calls and logs.
- **Rule 2: Strategic Logging**
  - Log significant events (errors, boundary crossings, state changes). Do not log noise.
  - *Context*: Logs must contain context (user ID, request ID), not just "Error occurred".
- **Rule 3: Security & Privacy**
  - **Strictly Prohibited**: Logging passwords, API keys, tokens, or sensitive PII (Personally Identifiable Information).
  - Use redaction/masking utilties if logging raw request bodies.
